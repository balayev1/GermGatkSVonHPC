# Include standard Cromwell settings
include required(classpath("application"))

system {
  job-rate-control {
    # Allows Cromwell to submit shards quickly
    jobs-per-second = 1
    max-total-combined-jobs-count = 100
  }
}

backend {
  default = "SlurmDocker"
  providers {
    SlurmDocker {
      actor-factory = "cromwell.backend.impl.sfs.config.ConfigBackendLifecycleActorFactory"
      config {
        job-id-regex = "Submitted batch job (\\d+)"
        check-alive = "squeue -j ${job_id}"
        kill = "scancel ${job_id}"

        # Define variables Cromwell will look for in the WDL
        runtime-attributes = """
        Int? cpu
        Int? memory_gb
        String? time
        String? docker
        """

        submit-docker = """
        set -euo pipefail

        # 1. Handle Singularity Image Pulling
        CACHE_DIR=$HOME/.singularity/cache
        mkdir -p $CACHE_DIR
        LOCK_FILE=$CACHE_DIR/singularity_pull_flock
        DOCKER_NAME=$(sed -e 's/[^A-Za-z0-9._-]/_/g' <<< ${docker})
        IMAGE=$CACHE_DIR/$DOCKER_NAME.sif

        (
          flock --verbose --exclusive --timeout 900 9 || exit 1
          if [ ! -e "$IMAGE" ]; then
            singularity build $IMAGE docker://${docker}
          fi
        ) 9>$LOCK_FILE

        # 2. Submit to Slurm with dynamic CPU and RAM
        # We set defaults (4 cores, 16GB) in case the WDL doesn't specify
        sbatch \
          -J ${job_name} \
          -D ${cwd} \
          -o ${cwd}/execution/stdout \
          -e ${cwd}/execution/stderr \
          --cpus-per-task=${default="4" cpu} \
          --mem=${default="16" memory_gb}G \
          --time=${default="24:00:00" time} \
          --partition=asvnode1,msibigmem \
          --wrap "singularity exec --containall \
            --bind ${cwd}:${docker_cwd} \
            --bind /scratch.global/balay011:/scratch.global/balay011 \
            --bind /projects/standard/aventeic/balay011:/projects/standard/aventeic/balay011 \
            $IMAGE ${job_shell} ${script}"
        """

        filesystems {
          local {
            localization: ["soft-link"]
            caching { duplication-strategy: ["soft-link"] }
            docker.allow-soft-links: true
          }
        }
      }
    }
  }
}